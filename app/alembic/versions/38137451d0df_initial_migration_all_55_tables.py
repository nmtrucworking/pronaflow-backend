"""Initial migration - all 55 tables

Revision ID: 38137451d0df
Revises: 2cc8dd3c96ed
Create Date: 2026-02-03 13:55:27.862455

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '38137451d0df'
down_revision = '2cc8dd3c96ed'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('categories',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('slug', sa.String(length=120), nullable=False),
    sa.Column('parent_id', sa.UUID(), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['parent_id'], ['categories.id'], name=op.f('fk_categories_parent_id_categories')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_categories'))
    )
    op.create_index('ix_categories_active', 'categories', ['is_active'], unique=False)
    op.create_index(op.f('ix_categories_name'), 'categories', ['name'], unique=False)
    op.create_index('ix_categories_parent', 'categories', ['parent_id'], unique=False)
    op.create_index(op.f('ix_categories_slug'), 'categories', ['slug'], unique=True)
    op.create_table('login_attempts',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False, comment='Email attempted to login'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP address of login attempt'),
    sa.Column('user_agent', sa.Text(), nullable=True, comment='User agent of login attempt'),
    sa.Column('success', sa.Boolean(), nullable=False, comment='Whether login attempt was successful'),
    sa.Column('reason', sa.String(length=255), nullable=True, comment="Reason for failed attempt (e.g., 'Invalid password', 'Account locked')"),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_login_attempts'))
    )
    op.create_index(op.f('ix_login_attempts_email'), 'login_attempts', ['email'], unique=False)
    op.create_table('oauth_apps',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for OAuth app'),
    sa.Column('provider_name', sa.String(length=50), nullable=False, comment='OAuth provider name (github, google_calendar, slack, etc.)'),
    sa.Column('client_id', sa.String(length=255), nullable=False, comment='OAuth client ID'),
    sa.Column('client_secret', sa.String(length=255), nullable=False, comment='OAuth client secret (should be encrypted)'),
    sa.Column('authorize_url', sa.String(length=500), nullable=False, comment='OAuth authorization endpoint URL'),
    sa.Column('token_url', sa.String(length=500), nullable=False, comment='OAuth token endpoint URL'),
    sa.Column('scopes', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='OAuth scopes required by PronaFlow'),
    sa.Column('is_enabled', sa.Boolean(), nullable=False, comment='Whether OAuth app is enabled for use'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_oauth_apps'))
    )
    op.create_index(op.f('ix_oauth_apps_is_enabled'), 'oauth_apps', ['is_enabled'], unique=False)
    op.create_index(op.f('ix_oauth_apps_provider_name'), 'oauth_apps', ['provider_name'], unique=True)
    op.create_table('plans',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for plan'),
    sa.Column('name', sa.String(length=100), nullable=False, comment="Plan name (e.g., 'Free', 'Pro', 'Enterprise')"),
    sa.Column('display_name', sa.String(length=100), nullable=False, comment='Friendly display name'),
    sa.Column('description', sa.Text(), nullable=True, comment='Plan description'),
    sa.Column('price_monthly', sa.Numeric(precision=10, scale=2), nullable=False, comment='Monthly price in USD'),
    sa.Column('price_yearly', sa.Numeric(precision=10, scale=2), nullable=False, comment='Yearly price in USD'),
    sa.Column('max_projects', sa.Integer(), nullable=False, comment='Maximum number of projects'),
    sa.Column('max_storage_gb', sa.Integer(), nullable=False, comment='Maximum storage in GB'),
    sa.Column('max_ai_tokens_monthly', sa.Integer(), nullable=False, comment='AI tokens quota per month'),
    sa.Column('max_users_per_workspace', sa.Integer(), nullable=False, comment='Maximum users per workspace'),
    sa.Column('features', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Feature flags (SSO, Custom Fields, Advanced AI, etc.)'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Whether plan is available for subscription'),
    sa.Column('is_public', sa.Boolean(), nullable=False, comment='Whether plan is publicly visible'),
    sa.Column('sort_order', sa.Integer(), nullable=False, comment='Display order (lower = shown first)'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_plans'))
    )
    op.create_index('ix_plans_is_active', 'plans', ['is_active'], unique=False)
    op.create_index(op.f('ix_plans_name'), 'plans', ['name'], unique=True)
    op.create_table('plugins',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for plugin'),
    sa.Column('name', sa.String(length=100), nullable=False, comment='Plugin name'),
    sa.Column('version', sa.String(length=20), nullable=False, comment='Current plugin version (semantic versioning)'),
    sa.Column('description', sa.Text(), nullable=True, comment='Plugin description'),
    sa.Column('author', sa.String(length=100), nullable=True, comment='Plugin author/developer'),
    sa.Column('manifest', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Plugin manifest (metadata, hooks, permissions)'),
    sa.Column('repository_url', sa.String(length=500), nullable=True, comment='Git repository URL'),
    sa.Column('documentation_url', sa.String(length=500), nullable=True, comment='Documentation URL'),
    sa.Column('icon_url', sa.String(length=500), nullable=True, comment='Plugin icon URL'),
    sa.Column('is_verified', sa.Boolean(), nullable=False, comment='Whether plugin is verified by PronaFlow team'),
    sa.Column('is_enabled', sa.Boolean(), nullable=False, comment='Whether plugin is available in marketplace'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_plugins'))
    )
    op.create_index('ix_plugins_is_enabled', 'plugins', ['is_enabled'], unique=False)
    op.create_index(op.f('ix_plugins_name'), 'plugins', ['name'], unique=True)
    op.create_table('articles',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('slug', sa.String(length=200), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('summary', sa.Text(), nullable=True),
    sa.Column('status', sa.Enum('DRAFT', 'PUBLISHED', 'ARCHIVED', name='articlestatus'), nullable=False),
    sa.Column('category_id', sa.UUID(), nullable=True),
    sa.Column('author_id', sa.UUID(), nullable=True),
    sa.Column('is_featured', sa.Boolean(), nullable=False),
    sa.Column('published_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('view_count', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['author_id'], ['users.id'], name=op.f('fk_articles_author_id_users')),
    sa.ForeignKeyConstraint(['category_id'], ['categories.id'], name=op.f('fk_articles_category_id_categories')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_articles'))
    )
    op.create_index('ix_articles_category', 'articles', ['category_id'], unique=False)
    op.create_index(op.f('ix_articles_slug'), 'articles', ['slug'], unique=True)
    op.create_index(op.f('ix_articles_status'), 'articles', ['status'], unique=False)
    op.create_table('email_verification_tokens',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False, comment='Email to be verified'),
    sa.Column('token', sa.String(length=500), nullable=False, comment='One-time verification token (hashed)'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False, comment='Token expiration time (default: 24 hours)'),
    sa.Column('verified_at', sa.DateTime(timezone=True), nullable=True, comment='When email was verified'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_email_verification_tokens_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_email_verification_tokens')),
    sa.UniqueConstraint('token', name=op.f('uq_email_verification_tokens_token'))
    )
    op.create_index(op.f('ix_email_verification_tokens_user_id'), 'email_verification_tokens', ['user_id'], unique=False)
    op.create_table('failed_searches',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=True),
    sa.Column('query_text', sa.String(length=500), nullable=False),
    sa.Column('locale', sa.String(length=10), nullable=True),
    sa.Column('route_path', sa.String(length=255), nullable=True),
    sa.Column('searched_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_failed_searches_user_id_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_failed_searches'))
    )
    op.create_index('ix_failed_searches_query', 'failed_searches', ['query_text'], unique=False)
    op.create_index('ix_failed_searches_searched_at', 'failed_searches', ['searched_at'], unique=False)
    op.create_table('oauth_providers',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('provider', sa.String(length=50), nullable=False, comment='OAuth provider name (google, github, etc.)'),
    sa.Column('provider_user_id', sa.String(length=255), nullable=False, comment='User ID from OAuth provider'),
    sa.Column('provider_email', sa.String(length=255), nullable=False, comment='Email from OAuth provider'),
    sa.Column('access_token', sa.Text(), nullable=True, comment='OAuth access token (encrypted)'),
    sa.Column('refresh_token', sa.Text(), nullable=True, comment='OAuth refresh token (encrypted)'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True, comment='Token expiration time'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_oauth_providers_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_oauth_providers'))
    )
    op.create_index('idx_oauth_provider_user', 'oauth_providers', ['provider', 'provider_user_id'], unique=True)
    op.create_index(op.f('ix_oauth_providers_user_id'), 'oauth_providers', ['user_id'], unique=False)
    op.create_table('password_reset_tokens',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('token', sa.String(length=500), nullable=False, comment='One-time reset token (hashed)'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False, comment='Token expiration time (default: 15 minutes)'),
    sa.Column('used_at', sa.DateTime(timezone=True), nullable=True, comment='When token was used'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_password_reset_tokens_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_password_reset_tokens')),
    sa.UniqueConstraint('token', name=op.f('uq_password_reset_tokens_token'))
    )
    op.create_index(op.f('ix_password_reset_tokens_user_id'), 'password_reset_tokens', ['user_id'], unique=False)
    op.create_table('api_usage_logs',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for usage log entry'),
    sa.Column('api_token_id', sa.UUID(), nullable=False, comment='API token used for the request'),
    sa.Column('method', sa.String(length=10), nullable=False, comment='HTTP method (GET, POST, PATCH, DELETE)'),
    sa.Column('endpoint', sa.String(length=255), nullable=False, comment='API endpoint path'),
    sa.Column('status_code', sa.Integer(), nullable=False, comment='HTTP response status code'),
    sa.Column('response_time_ms', sa.Integer(), nullable=False, comment='Response time in milliseconds'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['api_token_id'], ['api_tokens.id'], name=op.f('fk_api_usage_logs_api_token_id_api_tokens'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_api_usage_logs'))
    )
    op.create_index(op.f('ix_api_usage_logs_api_token_id'), 'api_usage_logs', ['api_token_id'], unique=False)
    op.create_index('ix_api_usage_logs_created_at', 'api_usage_logs', ['created_at'], unique=False)
    op.create_table('article_feedback',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('article_id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=True),
    sa.Column('is_helpful', sa.Boolean(), nullable=False),
    sa.Column('comment', sa.Text(), nullable=True),
    sa.Column('submitted_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('route_path', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['article_id'], ['articles.id'], name=op.f('fk_article_feedback_article_id_articles'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_article_feedback_user_id_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_article_feedback'))
    )
    op.create_index('ix_article_feedback_article', 'article_feedback', ['article_id'], unique=False)
    op.create_index('ix_article_feedback_user', 'article_feedback', ['user_id'], unique=False)
    op.create_table('article_search_indexes',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('article_id', sa.UUID(), nullable=False),
    sa.Column('keywords', sa.Text(), nullable=True),
    sa.Column('embedding_vector', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('snippet', sa.String(length=500), nullable=True),
    sa.Column('last_indexed', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['article_id'], ['articles.id'], name=op.f('fk_article_search_indexes_article_id_articles'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_article_search_indexes')),
    sa.UniqueConstraint('article_id', name=op.f('uq_article_search_indexes_article_id'))
    )
    op.create_index('ix_article_search_indexes_article', 'article_search_indexes', ['article_id'], unique=False)
    op.create_table('article_versions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('article_id', sa.UUID(), nullable=False),
    sa.Column('version_number', sa.Integer(), nullable=False),
    sa.Column('version_label', sa.String(length=50), nullable=True),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content_raw', sa.Text(), nullable=False),
    sa.Column('content_rendered', sa.Text(), nullable=True),
    sa.Column('changelog_summary', sa.Text(), nullable=True),
    sa.Column('is_current', sa.Boolean(), nullable=False),
    sa.Column('created_by_id', sa.UUID(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['article_id'], ['articles.id'], name=op.f('fk_article_versions_article_id_articles'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name=op.f('fk_article_versions_created_by_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_article_versions'))
    )
    op.create_index('ix_article_versions_article', 'article_versions', ['article_id'], unique=False)
    op.create_index('ix_article_versions_current', 'article_versions', ['is_current'], unique=False)
    op.create_table('article_visibility',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('article_id', sa.UUID(), nullable=False),
    sa.Column('access_scope', sa.Enum('PUBLIC', 'INTERNAL', 'ROLE_BASED', name='articlevisibilityscope'), nullable=False),
    sa.Column('allowed_roles', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['article_id'], ['articles.id'], name=op.f('fk_article_visibility_article_id_articles'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_article_visibility')),
    sa.UniqueConstraint('article_id', name=op.f('uq_article_visibility_article_id'))
    )
    op.create_index('ix_article_visibility_scope', 'article_visibility', ['access_scope'], unique=False)
    op.create_table('clients',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for client'),
    sa.Column('owner_id', sa.UUID(), nullable=False, comment='Client owner (freelancer)'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace reference'),
    sa.Column('name', sa.String(length=200), nullable=False, comment='Client name or company name'),
    sa.Column('email', sa.String(length=255), nullable=False, comment='Client email'),
    sa.Column('phone', sa.String(length=50), nullable=True, comment='Client phone number'),
    sa.Column('address_line1', sa.String(length=255), nullable=True, comment='Address line 1'),
    sa.Column('address_line2', sa.String(length=255), nullable=True, comment='Address line 2'),
    sa.Column('city', sa.String(length=100), nullable=True, comment='City'),
    sa.Column('state', sa.String(length=100), nullable=True, comment='State/Province'),
    sa.Column('postal_code', sa.String(length=20), nullable=True, comment='Postal/ZIP code'),
    sa.Column('country', sa.String(length=2), nullable=True, comment='Country code (ISO 3166-1 alpha-2)'),
    sa.Column('tax_id', sa.String(length=100), nullable=True, comment='Tax ID or VAT number'),
    sa.Column('default_hourly_rate', sa.Numeric(precision=10, scale=2), nullable=True, comment='Default hourly rate for freelancer invoices'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Whether client is active'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Internal notes about client'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['owner_id'], ['users.id'], name=op.f('fk_clients_owner_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_clients_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_clients'))
    )
    op.create_index('ix_clients_is_active', 'clients', ['is_active'], unique=False)
    op.create_index(op.f('ix_clients_owner_id'), 'clients', ['owner_id'], unique=False)
    op.create_index(op.f('ix_clients_workspace_id'), 'clients', ['workspace_id'], unique=False)
    op.create_table('consent_grants',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for consent grant'),
    sa.Column('user_id', sa.UUID(), nullable=False, comment='User who granted consent'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace context'),
    sa.Column('consent_type', sa.Enum('DATA_USAGE', 'THIRD_PARTY', 'ANALYTICS', 'MARKETING', name='consent_type'), nullable=False, comment='Type of consent (data_usage, third_party_integration, analytics, marketing)'),
    sa.Column('resource_type', sa.String(length=100), nullable=True, comment="Specific resource (e.g., 'slack_integration', 'google_analytics')"),
    sa.Column('resource_id', sa.UUID(), nullable=True, comment='ID of the specific resource if applicable'),
    sa.Column('description', sa.Text(), nullable=True, comment="Human-readable description of what's being consented to"),
    sa.Column('is_granted', sa.Boolean(), nullable=False, comment='Whether user granted consent'),
    sa.Column('granted_at', sa.DateTime(timezone=True), nullable=True, comment='When consent was granted'),
    sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=True, comment='When consent was revoked'),
    sa.Column('version', sa.Integer(), nullable=False, comment='Consent policy version (for tracking changes)'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_consent_grants_user_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_consent_grants_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_consent_grants'))
    )
    op.create_index('ix_consent_grants_consent_type', 'consent_grants', ['consent_type'], unique=False)
    op.create_index(op.f('ix_consent_grants_is_granted'), 'consent_grants', ['is_granted'], unique=False)
    op.create_index(op.f('ix_consent_grants_user_id'), 'consent_grants', ['user_id'], unique=False)
    op.create_index(op.f('ix_consent_grants_workspace_id'), 'consent_grants', ['workspace_id'], unique=False)
    op.create_table('holiday_calendars',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('workspace_id', sa.UUID(), nullable=False),
    sa.Column('holiday_date', sa.DateTime(timezone=True), nullable=False, comment='Date of holiday'),
    sa.Column('name', sa.String(length=255), nullable=False, comment="Holiday name (e.g., 'Christmas', 'Tet')"),
    sa.Column('is_recurring', sa.Boolean(), nullable=False, comment='Does it recur every year?'),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('fk_holiday_calendars_created_by_users')),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_holiday_calendars_workspace_id_workspaces')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_holiday_calendars')),
    sa.UniqueConstraint('workspace_id', 'holiday_date', name='uq_holiday_calendars_workspace_date')
    )
    op.create_index('ix_holiday_calendars_holiday_date', 'holiday_calendars', ['holiday_date'], unique=False)
    op.create_index('ix_holiday_calendars_workspace_id', 'holiday_calendars', ['workspace_id'], unique=False)
    op.create_table('invoices',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for invoice'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace reference'),
    sa.Column('invoice_number', sa.String(length=50), nullable=False, comment="Human-readable invoice number (e.g., 'INV-2026-001')"),
    sa.Column('issue_date', sa.Date(), nullable=False, comment='Invoice issue date'),
    sa.Column('due_date', sa.Date(), nullable=False, comment='Payment due date'),
    sa.Column('subtotal', sa.Numeric(precision=10, scale=2), nullable=False, comment='Subtotal before tax'),
    sa.Column('tax_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Tax amount'),
    sa.Column('tax_rate', sa.Numeric(precision=5, scale=2), nullable=False, comment='Tax rate percentage'),
    sa.Column('total', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total amount (subtotal + tax)'),
    sa.Column('currency', sa.String(length=3), nullable=False, comment='Currency code (ISO 4217)'),
    sa.Column('status', sa.String(length=20), nullable=False, comment="Status: 'draft', 'sent', 'paid', 'overdue', 'void', 'cancelled'"),
    sa.Column('paid_at', sa.DateTime(timezone=True), nullable=True, comment='Payment timestamp'),
    sa.Column('is_locked', sa.Boolean(), nullable=False, comment='Whether invoice is locked (immutable)'),
    sa.Column('locked_at', sa.DateTime(timezone=True), nullable=True, comment='Lock timestamp'),
    sa.Column('stripe_invoice_id', sa.String(length=255), nullable=True, comment='Stripe invoice ID'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Invoice notes or terms'),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Additional metadata'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_invoices_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_invoices')),
    sa.UniqueConstraint('stripe_invoice_id', name=op.f('uq_invoices_stripe_invoice_id'))
    )
    op.create_index('ix_invoices_due_date', 'invoices', ['due_date'], unique=False)
    op.create_index('ix_invoices_invoice_number', 'invoices', ['invoice_number'], unique=False)
    op.create_index(op.f('ix_invoices_status'), 'invoices', ['status'], unique=False)
    op.create_index('ix_invoices_workspace_id', 'invoices', ['workspace_id'], unique=False)
    op.create_table('oauth_connections',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for OAuth connection'),
    sa.Column('user_id', sa.UUID(), nullable=False, comment='User who owns the connection'),
    sa.Column('oauth_app_id', sa.UUID(), nullable=False, comment='OAuth app being connected'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace context'),
    sa.Column('access_token', sa.String(length=500), nullable=False, comment='OAuth access token (should be encrypted)'),
    sa.Column('refresh_token', sa.String(length=500), nullable=True, comment='OAuth refresh token (should be encrypted)'),
    sa.Column('token_expires_at', sa.DateTime(timezone=True), nullable=True, comment='Token expiration timestamp'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Whether connection is active'),
    sa.Column('last_verified_at', sa.DateTime(timezone=True), nullable=True, comment='Last time token was verified as valid'),
    sa.Column('external_user_id', sa.String(length=255), nullable=True, comment='External service user ID'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['oauth_app_id'], ['oauth_apps.id'], name=op.f('fk_oauth_connections_oauth_app_id_oauth_apps'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_oauth_connections_user_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_oauth_connections_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_oauth_connections'))
    )
    op.create_index(op.f('ix_oauth_connections_is_active'), 'oauth_connections', ['is_active'], unique=False)
    op.create_index(op.f('ix_oauth_connections_user_id'), 'oauth_connections', ['user_id'], unique=False)
    op.create_index(op.f('ix_oauth_connections_workspace_id'), 'oauth_connections', ['workspace_id'], unique=False)
    op.create_table('plugin_installations',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for plugin installation'),
    sa.Column('plugin_id', sa.UUID(), nullable=False, comment='Plugin being installed'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace where plugin is installed'),
    sa.Column('installed_by', sa.UUID(), nullable=False, comment='User who installed the plugin'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Whether plugin is active'),
    sa.Column('configuration', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Plugin-specific configuration'),
    sa.Column('last_error', sa.Text(), nullable=True, comment='Last error message if plugin failed'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['installed_by'], ['users.id'], name=op.f('fk_plugin_installations_installed_by_users'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['plugin_id'], ['plugins.id'], name=op.f('fk_plugin_installations_plugin_id_plugins'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_plugin_installations_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_plugin_installations'))
    )
    op.create_index('ix_plugin_installations_is_active', 'plugin_installations', ['is_active'], unique=False)
    op.create_index(op.f('ix_plugin_installations_workspace_id'), 'plugin_installations', ['workspace_id'], unique=False)
    op.create_table('route_mappings',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('article_id', sa.UUID(), nullable=False),
    sa.Column('route_pattern', sa.String(length=255), nullable=False),
    sa.Column('element_selector', sa.String(length=255), nullable=True),
    sa.Column('context_description', sa.Text(), nullable=True),
    sa.Column('priority', sa.Integer(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['article_id'], ['articles.id'], name=op.f('fk_route_mappings_article_id_articles'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_route_mappings'))
    )
    op.create_index('ix_route_mappings_active', 'route_mappings', ['is_active'], unique=False)
    op.create_index('ix_route_mappings_pattern', 'route_mappings', ['route_pattern'], unique=False)
    op.create_index('ix_route_mappings_priority', 'route_mappings', ['priority'], unique=False)
    op.create_index(op.f('ix_route_mappings_route_pattern'), 'route_mappings', ['route_pattern'], unique=False)
    op.create_table('working_hours_policies',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('workspace_id', sa.UUID(), nullable=False),
    sa.Column('working_days_mask', sa.Integer(), nullable=False, comment='Bitmask: 0=Mon...6=Sun. Default: Mon-Fri'),
    sa.Column('work_start_time', sa.String(length=8), nullable=False, comment='HH:MM format'),
    sa.Column('work_end_time', sa.String(length=8), nullable=False, comment='HH:MM format'),
    sa.Column('lunch_start_time', sa.String(length=8), nullable=True, comment='Optional lunch break start'),
    sa.Column('lunch_end_time', sa.String(length=8), nullable=True, comment='Optional lunch break end'),
    sa.Column('timezone', sa.String(length=50), nullable=False, comment='Timezone for schedule calculations'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_working_hours_policies_workspace_id_workspaces')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_working_hours_policies'))
    )
    op.create_index('ix_working_hours_policies_workspace_id', 'working_hours_policies', ['workspace_id'], unique=False)
    op.create_table('workspace_subscriptions',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for subscription'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace reference'),
    sa.Column('plan_id', sa.UUID(), nullable=False, comment='Plan reference'),
    sa.Column('billing_cycle', sa.String(length=20), nullable=False, comment="Billing cycle: 'monthly' or 'yearly'"),
    sa.Column('start_date', sa.Date(), nullable=False, comment='Subscription start date'),
    sa.Column('end_date', sa.Date(), nullable=True, comment='Subscription end date (null = ongoing)'),
    sa.Column('next_billing_date', sa.Date(), nullable=True, comment='Next billing date'),
    sa.Column('status', sa.String(length=20), nullable=False, comment="Status: 'trial', 'active', 'cancelled', 'expired', 'grace_period'"),
    sa.Column('is_trial', sa.Boolean(), nullable=False, comment='Whether this is a trial subscription'),
    sa.Column('trial_end_date', sa.Date(), nullable=True, comment='Trial end date'),
    sa.Column('cancelled_at', sa.DateTime(timezone=True), nullable=True, comment='Cancellation timestamp'),
    sa.Column('cancellation_reason', sa.Text(), nullable=True, comment='Reason for cancellation'),
    sa.Column('stripe_subscription_id', sa.String(length=255), nullable=True, comment='Stripe subscription ID'),
    sa.Column('auto_renew', sa.Boolean(), nullable=False, comment='Whether subscription auto-renews'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['plan_id'], ['plans.id'], name=op.f('fk_workspace_subscriptions_plan_id_plans'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_workspace_subscriptions_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_workspace_subscriptions')),
    sa.UniqueConstraint('stripe_subscription_id', name=op.f('uq_workspace_subscriptions_stripe_subscription_id'))
    )
    op.create_index('ix_workspace_subscriptions_next_billing_date', 'workspace_subscriptions', ['next_billing_date'], unique=False)
    op.create_index(op.f('ix_workspace_subscriptions_plan_id'), 'workspace_subscriptions', ['plan_id'], unique=False)
    op.create_index('ix_workspace_subscriptions_status', 'workspace_subscriptions', ['status'], unique=False)
    op.create_index(op.f('ix_workspace_subscriptions_workspace_id'), 'workspace_subscriptions', ['workspace_id'], unique=False)
    op.create_table('article_tag_map',
    sa.Column('article_id', sa.UUID(), nullable=False),
    sa.Column('tag_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['article_id'], ['articles.id'], name=op.f('fk_article_tag_map_article_id_articles'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['tag_id'], ['tags.id'], name=op.f('fk_article_tag_map_tag_id_tags'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('article_id', 'tag_id', name=op.f('pk_article_tag_map'))
    )
    op.create_table('article_translations',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('version_id', sa.UUID(), nullable=False),
    sa.Column('locale', sa.String(length=10), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content_localized', sa.Text(), nullable=False),
    sa.Column('is_default', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['version_id'], ['article_versions.id'], name=op.f('fk_article_translations_version_id_article_versions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_article_translations'))
    )
    op.create_index('ix_article_translations_locale', 'article_translations', ['locale'], unique=False)
    op.create_index('ix_article_translations_version', 'article_translations', ['version_id'], unique=False)
    op.create_table('billing_transactions',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for transaction'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace reference'),
    sa.Column('invoice_id', sa.UUID(), nullable=True, comment='Related invoice'),
    sa.Column('transaction_type', sa.String(length=50), nullable=False, comment="Type: 'payment', 'refund', 'credit'"),
    sa.Column('amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Transaction amount in USD'),
    sa.Column('currency', sa.String(length=3), nullable=False, comment='Currency code (ISO 4217)'),
    sa.Column('status', sa.String(length=20), nullable=False, comment="Status: 'pending', 'succeeded', 'failed', 'refunded'"),
    sa.Column('payment_method', sa.String(length=50), nullable=False, comment="Payment method: 'stripe', 'paypal', 'bank_transfer'"),
    sa.Column('stripe_charge_id', sa.String(length=255), nullable=True, comment='Stripe charge ID'),
    sa.Column('stripe_payment_intent_id', sa.String(length=255), nullable=True, comment='Stripe payment intent ID'),
    sa.Column('idempotency_key', sa.String(length=255), nullable=False, comment='Idempotency key to prevent double charging'),
    sa.Column('description', sa.Text(), nullable=True, comment='Transaction description'),
    sa.Column('failure_reason', sa.Text(), nullable=True, comment="Failure reason if status is 'failed'"),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Additional metadata'),
    sa.Column('processed_at', sa.DateTime(timezone=True), nullable=True, comment='Transaction processing timestamp'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['invoice_id'], ['invoices.id'], name=op.f('fk_billing_transactions_invoice_id_invoices'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_billing_transactions_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_billing_transactions')),
    sa.UniqueConstraint('idempotency_key', name=op.f('uq_billing_transactions_idempotency_key')),
    sa.UniqueConstraint('stripe_charge_id', name=op.f('uq_billing_transactions_stripe_charge_id')),
    sa.UniqueConstraint('stripe_payment_intent_id', name=op.f('uq_billing_transactions_stripe_payment_intent_id'))
    )
    op.create_index('ix_billing_transactions_created_at', 'billing_transactions', ['created_at'], unique=False)
    op.create_index(op.f('ix_billing_transactions_invoice_id'), 'billing_transactions', ['invoice_id'], unique=False)
    op.create_index('ix_billing_transactions_status', 'billing_transactions', ['status'], unique=False)
    op.create_index(op.f('ix_billing_transactions_workspace_id'), 'billing_transactions', ['workspace_id'], unique=False)
    op.create_table('freelancer_invoices',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for freelancer invoice'),
    sa.Column('client_id', sa.UUID(), nullable=False, comment='Client reference'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace reference'),
    sa.Column('created_by_id', sa.UUID(), nullable=False, comment='Invoice creator (freelancer)'),
    sa.Column('invoice_number', sa.String(length=50), nullable=False, comment='Human-readable invoice number'),
    sa.Column('issue_date', sa.Date(), nullable=False, comment='Invoice issue date'),
    sa.Column('due_date', sa.Date(), nullable=False, comment='Payment due date'),
    sa.Column('subtotal', sa.Numeric(precision=10, scale=2), nullable=False, comment='Subtotal before tax'),
    sa.Column('hourly_rate', sa.Numeric(precision=10, scale=2), nullable=True, comment='Hourly rate used for calculation'),
    sa.Column('tax_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Tax amount'),
    sa.Column('total', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total amount'),
    sa.Column('currency', sa.String(length=3), nullable=False, comment='Currency code'),
    sa.Column('status', sa.String(length=20), nullable=False, comment="Status: 'draft', 'sent', 'paid', 'overdue', 'cancelled'"),
    sa.Column('sent_at', sa.DateTime(timezone=True), nullable=True, comment='Sent timestamp'),
    sa.Column('paid_at', sa.DateTime(timezone=True), nullable=True, comment='Payment timestamp'),
    sa.Column('logo_url', sa.String(length=500), nullable=True, comment='Custom logo URL (Pro only)'),
    sa.Column('brand_color', sa.String(length=7), nullable=True, comment='Brand color hex code (Pro only)'),
    sa.Column('hide_branding', sa.Boolean(), nullable=False, comment="Hide 'Powered by PronaFlow' (Pro only)"),
    sa.Column('notes', sa.Text(), nullable=True, comment='Invoice notes or terms'),
    sa.Column('timesheet_entry_ids', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='List of timesheet entry IDs included in this invoice'),
    sa.Column('pdf_url', sa.String(length=500), nullable=True, comment='Generated PDF URL'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['client_id'], ['clients.id'], name=op.f('fk_freelancer_invoices_client_id_clients'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name=op.f('fk_freelancer_invoices_created_by_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_freelancer_invoices_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_freelancer_invoices'))
    )
    op.create_index('ix_freelancer_invoices_client_id', 'freelancer_invoices', ['client_id'], unique=False)
    op.create_index('ix_freelancer_invoices_created_by_id', 'freelancer_invoices', ['created_by_id'], unique=False)
    op.create_index('ix_freelancer_invoices_due_date', 'freelancer_invoices', ['due_date'], unique=False)
    op.create_index(op.f('ix_freelancer_invoices_invoice_number'), 'freelancer_invoices', ['invoice_number'], unique=True)
    op.create_index('ix_freelancer_invoices_status', 'freelancer_invoices', ['status'], unique=False)
    op.create_index(op.f('ix_freelancer_invoices_workspace_id'), 'freelancer_invoices', ['workspace_id'], unique=False)
    op.create_table('invoice_line_items',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for line item'),
    sa.Column('invoice_id', sa.UUID(), nullable=False, comment='Invoice reference'),
    sa.Column('description', sa.Text(), nullable=False, comment='Line item description'),
    sa.Column('quantity', sa.Numeric(precision=10, scale=2), nullable=False, comment='Quantity'),
    sa.Column('unit_price', sa.Numeric(precision=10, scale=2), nullable=False, comment='Unit price'),
    sa.Column('amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total amount (quantity Ã— unit_price)'),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Additional metadata (e.g., timesheet_entry_ids)'),
    sa.Column('sort_order', sa.Integer(), nullable=False, comment='Display order'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['invoice_id'], ['invoices.id'], name=op.f('fk_invoice_line_items_invoice_id_invoices'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_invoice_line_items'))
    )
    op.create_index('ix_invoice_line_items_invoice_id', 'invoice_line_items', ['invoice_id'], unique=False)
    op.create_table('notes',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=True),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('parent_note_id', sa.UUID(), nullable=True),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('access_level', sa.Enum('PRIVATE', 'PROJECT', 'WORKSPACE', 'PUBLIC', name='noteaccessenum'), nullable=False),
    sa.Column('is_template', sa.Boolean(), nullable=False),
    sa.Column('template_name', sa.String(length=255), nullable=True),
    sa.Column('template_description', sa.Text(), nullable=True),
    sa.Column('template_category', sa.String(length=100), nullable=True),
    sa.Column('is_pinned', sa.Boolean(), nullable=False),
    sa.Column('order_index', sa.Integer(), nullable=False),
    sa.Column('view_count', sa.Integer(), nullable=False),
    sa.Column('comment_count', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['parent_note_id'], ['notes.id'], name=op.f('fk_notes_parent_note_id_notes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_notes_project_id_projects'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_notes_user_id_users'), ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_notes'))
    )
    op.create_index('ix_notes_access_level', 'notes', ['access_level'], unique=False)
    op.create_index('ix_notes_is_template', 'notes', ['is_template'], unique=False)
    op.create_index(op.f('ix_notes_parent_note_id'), 'notes', ['parent_note_id'], unique=False)
    op.create_index('ix_notes_project_created', 'notes', ['project_id', 'created_at'], unique=False)
    op.create_index(op.f('ix_notes_project_id'), 'notes', ['project_id'], unique=False)
    op.create_index('ix_notes_project_title', 'notes', ['project_id', 'title'], unique=False)
    op.create_index('ix_notes_user_created', 'notes', ['user_id', 'created_at'], unique=False)
    op.create_table('personal_exceptions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=False),
    sa.Column('exception_date', sa.DateTime(timezone=True), nullable=False, comment='Date of exception'),
    sa.Column('exception_type', sa.String(length=50), nullable=False, comment='VACATION, SICK_LEAVE, HALF_DAY'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_personal_exceptions_project_id_projects')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_personal_exceptions_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_personal_exceptions'))
    )
    op.create_index('ix_personal_exceptions_exception_date', 'personal_exceptions', ['exception_date'], unique=False)
    op.create_index('ix_personal_exceptions_project_id', 'personal_exceptions', ['project_id'], unique=False)
    op.create_index('ix_personal_exceptions_user_id', 'personal_exceptions', ['user_id'], unique=False)
    op.create_table('plan_states',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=False),
    sa.Column('state', sa.String(length=50), nullable=False),
    sa.Column('submitted_by', sa.UUID(), nullable=True),
    sa.Column('submitted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('approved_by', sa.UUID(), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('locked_by', sa.UUID(), nullable=True),
    sa.Column('locked_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True, comment='Approval notes or rejection reason'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['approved_by'], ['users.id'], name=op.f('fk_plan_states_approved_by_users')),
    sa.ForeignKeyConstraint(['locked_by'], ['users.id'], name=op.f('fk_plan_states_locked_by_users')),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_plan_states_project_id_projects')),
    sa.ForeignKeyConstraint(['submitted_by'], ['users.id'], name=op.f('fk_plan_states_submitted_by_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_plan_states'))
    )
    op.create_index('ix_plan_states_project_id', 'plan_states', ['project_id'], unique=False)
    op.create_table('resource_histograms',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('histogram_date', sa.DateTime(timezone=True), nullable=False, comment='Date of histogram calculation'),
    sa.Column('planned_hours', sa.Float(), nullable=False, comment='Planned working hours for this date'),
    sa.Column('is_overloaded', sa.Boolean(), nullable=False, comment='Is > 8 hours planned?'),
    sa.Column('overload_hours', sa.Float(), nullable=False, comment='Excess hours over 8'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_resource_histograms_project_id_projects')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_resource_histograms_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_resource_histograms'))
    )
    op.create_index('ix_resource_histograms_histogram_date', 'resource_histograms', ['histogram_date'], unique=False)
    op.create_index('ix_resource_histograms_project_id', 'resource_histograms', ['project_id'], unique=False)
    op.create_index('ix_resource_histograms_user_id', 'resource_histograms', ['user_id'], unique=False)
    op.create_table('search_indexes',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('entity_type', sa.String(length=50), nullable=False),
    sa.Column('entity_id', sa.String(length=36), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=True),
    sa.Column('title', sa.String(length=255), nullable=True),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('snippet', sa.String(length=500), nullable=True),
    sa.Column('url_path', sa.String(length=500), nullable=True),
    sa.Column('created_by', sa.String(length=36), nullable=True),
    sa.Column('original_created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_search_indexes_project_id_projects'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_search_indexes'))
    )
    op.create_index('ix_search_indexes_entity', 'search_indexes', ['entity_type', 'entity_id'], unique=False)
    op.create_index(op.f('ix_search_indexes_entity_id'), 'search_indexes', ['entity_id'], unique=False)
    op.create_index('ix_search_indexes_project', 'search_indexes', ['project_id'], unique=False)
    op.create_table('simulation_sessions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=False),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Is simulation still running?'),
    sa.Column('delta_project_end_days', sa.Integer(), nullable=True, comment='Project end date shift (days)'),
    sa.Column('new_critical_path_count', sa.Integer(), nullable=True, comment='Number of tasks newly on critical path'),
    sa.Column('sla_at_risk_count', sa.Integer(), nullable=True, comment='Tasks at risk of SLA breach'),
    sa.Column('resource_overload_increase', sa.Integer(), nullable=True, comment='Additional overload instances'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('fk_simulation_sessions_created_by_users')),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_simulation_sessions_project_id_projects')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_simulation_sessions'))
    )
    op.create_index('ix_simulation_sessions_is_active', 'simulation_sessions', ['is_active'], unique=False)
    op.create_index('ix_simulation_sessions_project_id', 'simulation_sessions', ['project_id'], unique=False)
    op.create_table('sla_policies',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=False),
    sa.Column('priority', sa.String(length=50), nullable=False, comment='CRITICAL, HIGH, MEDIUM, LOW'),
    sa.Column('sla_hours', sa.Integer(), nullable=False, comment='SLA target in working hours'),
    sa.Column('warning_threshold_percent', sa.Integer(), nullable=False, comment='Warn at X% of SLA time consumed'),
    sa.Column('enable_escalation', sa.Boolean(), nullable=False),
    sa.Column('escalation_level_1_hours', sa.Integer(), nullable=True, comment='Hours after breached for Level 1 escalation'),
    sa.Column('escalation_level_2_hours', sa.Integer(), nullable=True, comment='Hours after breached for Level 2 escalation'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('fk_sla_policies_project_id_projects')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sla_policies')),
    sa.UniqueConstraint('project_id', 'priority', name='uq_sla_policies_project_priority')
    )
    op.create_index('ix_sla_policies_project_id', 'sla_policies', ['project_id'], unique=False)
    op.create_table('subscription_usages',
    sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for usage record'),
    sa.Column('workspace_id', sa.UUID(), nullable=False, comment='Workspace reference'),
    sa.Column('subscription_id', sa.UUID(), nullable=False, comment='Subscription reference'),
    sa.Column('period_start', sa.Date(), nullable=False, comment='Usage period start'),
    sa.Column('period_end', sa.Date(), nullable=False, comment='Usage period end'),
    sa.Column('projects_count', sa.Integer(), nullable=False, comment='Number of active projects'),
    sa.Column('storage_used_bytes', sa.Integer(), nullable=False, comment='Storage used in bytes'),
    sa.Column('ai_tokens_used', sa.Integer(), nullable=False, comment='AI tokens consumed'),
    sa.Column('api_calls_count', sa.Integer(), nullable=False, comment='API calls made'),
    sa.Column('users_count', sa.Integer(), nullable=False, comment='Number of active users'),
    sa.Column('storage_breakdown', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Storage breakdown by category (files, database, backups)'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['subscription_id'], ['workspace_subscriptions.id'], name=op.f('fk_subscription_usages_subscription_id_workspace_subscriptions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name=op.f('fk_subscription_usages_workspace_id_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_subscription_usages'))
    )
    op.create_index('ix_subscription_usages_period', 'subscription_usages', ['period_start', 'period_end'], unique=False)
    op.create_index(op.f('ix_subscription_usages_subscription_id'), 'subscription_usages', ['subscription_id'], unique=False)
    op.create_index('ix_subscription_usages_workspace_id', 'subscription_usages', ['workspace_id'], unique=False)
    op.create_table('note_versions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('note_id', sa.UUID(), nullable=False),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('version_number', sa.Integer(), nullable=False),
    sa.Column('change_description', sa.String(length=255), nullable=True),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('added_content', sa.Text(), nullable=True),
    sa.Column('removed_content', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('fk_note_versions_created_by_users'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['note_id'], ['notes.id'], name=op.f('fk_note_versions_note_id_notes'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_note_versions')),
    sa.UniqueConstraint('note_id', 'version_number', name='uq_note_version_number')
    )
    op.create_index('ix_note_versions_created', 'note_versions', ['created_at'], unique=False)
    op.create_index(op.f('ix_note_versions_note_id'), 'note_versions', ['note_id'], unique=False)
    op.create_table('public_links',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('note_id', sa.UUID(), nullable=False),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('slug', sa.String(length=100), nullable=False),
    sa.Column('link_title', sa.String(length=255), nullable=True),
    sa.Column('password_hash', sa.String(length=255), nullable=True),
    sa.Column('is_password_protected', sa.Boolean(), nullable=False),
    sa.Column('expiration_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.Enum('ACTIVE', 'EXPIRED', 'DISABLED', 'PASSWORD_PROTECTED', name='publiclinkstatusenum'), nullable=False),
    sa.Column('view_count', sa.Integer(), nullable=False),
    sa.Column('last_accessed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('auto_update', sa.Boolean(), nullable=False),
    sa.Column('last_published_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('fk_public_links_created_by_users'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['note_id'], ['notes.id'], name=op.f('fk_public_links_note_id_notes'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_public_links'))
    )
    op.create_index('ix_public_links_expiration', 'public_links', ['expiration_date'], unique=False)
    op.create_index('ix_public_links_note', 'public_links', ['note_id'], unique=False)
    op.create_index(op.f('ix_public_links_note_id'), 'public_links', ['note_id'], unique=False)
    op.create_index(op.f('ix_public_links_slug'), 'public_links', ['slug'], unique=True)
    op.create_index('ix_public_links_status', 'public_links', ['status'], unique=False)
    op.create_table('cross_project_dependencies',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('source_task_id', sa.UUID(), nullable=False, comment='Task in source project'),
    sa.Column('source_project_id', sa.UUID(), nullable=False),
    sa.Column('target_task_id', sa.UUID(), nullable=False, comment='Task in target project'),
    sa.Column('target_project_id', sa.UUID(), nullable=False),
    sa.Column('dependency_type', sa.String(length=10), nullable=False, comment='FS, SS, FF, SF'),
    sa.Column('is_broken', sa.Boolean(), nullable=False, comment='Broken link? (e.g., source task deleted)'),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('fk_cross_project_dependencies_created_by_users')),
    sa.ForeignKeyConstraint(['source_project_id'], ['projects.id'], name=op.f('fk_cross_project_dependencies_source_project_id_projects')),
    sa.ForeignKeyConstraint(['source_task_id'], ['tasks.id'], name=op.f('fk_cross_project_dependencies_source_task_id_tasks')),
    sa.ForeignKeyConstraint(['target_project_id'], ['projects.id'], name=op.f('fk_cross_project_dependencies_target_project_id_projects')),
    sa.ForeignKeyConstraint(['target_task_id'], ['tasks.id'], name=op.f('fk_cross_project_dependencies_target_task_id_tasks')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_cross_project_dependencies')),
    sa.UniqueConstraint('source_task_id', 'target_task_id', name='uq_cross_project_dep_tasks')
    )
    op.create_index('ix_cross_project_dependencies_source', 'cross_project_dependencies', ['source_project_id', 'source_task_id'], unique=False)
    op.create_index('ix_cross_project_dependencies_target', 'cross_project_dependencies', ['target_project_id', 'target_task_id'], unique=False)
    op.create_table('planning_audit_logs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=False),
    sa.Column('change_type', sa.String(length=50), nullable=False, comment='START_DATE, END_DATE, DURATION, DEPENDENCY'),
    sa.Column('old_value', sa.Text(), nullable=True, comment='Previous value'),
    sa.Column('new_value', sa.Text(), nullable=False, comment='New value'),
    sa.Column('reason', sa.Text(), nullable=True, comment='Why was it changed?'),
    sa.Column('changed_by', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['changed_by'], ['users.id'], name=op.f('fk_planning_audit_logs_changed_by_users')),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_planning_audit_logs_task_id_tasks')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_planning_audit_logs'))
    )
    op.create_index('ix_planning_audit_logs_change_type', 'planning_audit_logs', ['change_type'], unique=False)
    op.create_index('ix_planning_audit_logs_changed_by', 'planning_audit_logs', ['changed_by'], unique=False)
    op.create_index('ix_planning_audit_logs_task_id', 'planning_audit_logs', ['task_id'], unique=False)
    op.create_table('planning_scopes',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=False),
    sa.Column('include_in_planning', sa.Boolean(), nullable=False, comment='Include in Gantt, CPM, auto-scheduling'),
    sa.Column('override_parent', sa.Boolean(), nullable=False, comment="Override parent's scope setting?"),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_planning_scopes_task_id_tasks')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_planning_scopes')),
    sa.UniqueConstraint('task_id', name=op.f('uq_planning_scopes_task_id'))
    )
    op.create_index('ix_planning_scopes_task_id', 'planning_scopes', ['task_id'], unique=False)
    op.create_table('scheduling_modes',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=False),
    sa.Column('mode', sa.String(length=50), nullable=False, comment='AUTO or MANUAL'),
    sa.Column('is_pinned', sa.Boolean(), nullable=False, comment='Pinned to specific dates'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_scheduling_modes_task_id_tasks')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_scheduling_modes')),
    sa.UniqueConstraint('task_id', name=op.f('uq_scheduling_modes_task_id'))
    )
    op.create_index('ix_scheduling_modes_task_id', 'scheduling_modes', ['task_id'], unique=False)
    op.create_table('sla_trackers',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False, comment='ON_TRACK, AT_RISK, BREACHED'),
    sa.Column('sla_start_time', sa.DateTime(timezone=True), nullable=False, comment='When SLA timer started (task -> IN_PROGRESS)'),
    sa.Column('sla_breach_time', sa.DateTime(timezone=True), nullable=True, comment='When SLA was breached (if any)'),
    sa.Column('sla_deadline', sa.DateTime(timezone=True), nullable=False, comment='Calculated SLA deadline in business time'),
    sa.Column('elapsed_business_seconds', sa.Integer(), nullable=False),
    sa.Column('paused_business_seconds', sa.Integer(), nullable=False, comment='Total paused time (e.g., waiting for customer)'),
    sa.Column('is_paused', sa.Boolean(), nullable=False, comment='Is timer currently paused?'),
    sa.Column('pause_reason', sa.String(length=255), nullable=True, comment='Why is timer paused? (e.g., Blocked, Waiting)'),
    sa.Column('paused_at', sa.DateTime(timezone=True), nullable=True, comment='When was timer paused?'),
    sa.Column('escalation_level_1_triggered', sa.Boolean(), nullable=False),
    sa.Column('escalation_level_1_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('escalation_level_2_triggered', sa.Boolean(), nullable=False),
    sa.Column('escalation_level_2_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_sla_trackers_task_id_tasks')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sla_trackers')),
    sa.UniqueConstraint('task_id', name=op.f('uq_sla_trackers_task_id'))
    )
    op.create_index('ix_sla_trackers_status', 'sla_trackers', ['status'], unique=False)
    op.create_index('ix_sla_trackers_task_id', 'sla_trackers', ['task_id'], unique=False)
    op.create_table('smart_backlinks',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('note_id', sa.UUID(), nullable=False),
    sa.Column('source_note_id', sa.UUID(), nullable=True),
    sa.Column('source_task_id', sa.UUID(), nullable=True),
    sa.Column('mention_text', sa.String(length=255), nullable=False),
    sa.Column('is_linked', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['note_id'], ['notes.id'], name=op.f('fk_smart_backlinks_note_id_notes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['source_note_id'], ['notes.id'], name=op.f('fk_smart_backlinks_source_note_id_notes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['source_task_id'], ['tasks.id'], name=op.f('fk_smart_backlinks_source_task_id_tasks'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_smart_backlinks'))
    )
    op.create_index('ix_smart_backlinks_note', 'smart_backlinks', ['note_id'], unique=False)
    op.create_index(op.f('ix_smart_backlinks_note_id'), 'smart_backlinks', ['note_id'], unique=False)
    op.create_index('ix_smart_backlinks_source_note', 'smart_backlinks', ['source_note_id'], unique=False)
    op.create_table('task_baselines',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=False),
    sa.Column('baseline_version', sa.Integer(), nullable=False, comment='Baseline version number (1, 2, ...)'),
    sa.Column('baseline_start', sa.DateTime(timezone=True), nullable=False, comment='Planned start date at baseline creation'),
    sa.Column('baseline_end', sa.DateTime(timezone=True), nullable=False, comment='Planned end date at baseline creation'),
    sa.Column('baseline_duration_hours', sa.Float(), nullable=False, comment='Estimated hours at baseline creation'),
    sa.Column('actual_start', sa.DateTime(timezone=True), nullable=True, comment='Actual start date (when status -> IN_PROGRESS)'),
    sa.Column('actual_end', sa.DateTime(timezone=True), nullable=True, comment='Actual end date (when status -> DONE)'),
    sa.Column('actual_duration_hours', sa.Float(), nullable=True, comment='Actual hours spent'),
    sa.Column('schedule_variance_days', sa.Float(), nullable=True, comment='Difference between planned and actual start (days)'),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('fk_task_baselines_created_by_users')),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_task_baselines_task_id_tasks')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_task_baselines')),
    sa.UniqueConstraint('task_id', 'baseline_version', name='uq_task_baselines_task_version')
    )
    op.create_index('ix_task_baselines_baseline_version', 'task_baselines', ['baseline_version'], unique=False)
    op.create_index('ix_task_baselines_task_id', 'task_baselines', ['task_id'], unique=False)
    op.create_table('user_presence',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=True),
    sa.Column('note_id', sa.UUID(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('is_typing', sa.Boolean(), nullable=False),
    sa.Column('last_activity_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('session_id', sa.String(length=100), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['note_id'], ['notes.id'], name=op.f('fk_user_presence_note_id_notes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_user_presence_task_id_tasks'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_user_presence_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_user_presence'))
    )
    op.create_index('ix_user_presence_note', 'user_presence', ['note_id'], unique=False)
    op.create_index(op.f('ix_user_presence_note_id'), 'user_presence', ['note_id'], unique=False)
    op.create_index('ix_user_presence_task', 'user_presence', ['task_id'], unique=False)
    op.create_index(op.f('ix_user_presence_task_id'), 'user_presence', ['task_id'], unique=False)
    op.create_index('ix_user_presence_user', 'user_presence', ['user_id'], unique=False)
    op.create_index(op.f('ix_user_presence_user_id'), 'user_presence', ['user_id'], unique=False)
    op.create_table('approval_records',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=True),
    sa.Column('file_id', sa.UUID(), nullable=True),
    sa.Column('approver_id', sa.UUID(), nullable=False),
    sa.Column('requestor_id', sa.UUID(), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'APPROVED', 'CHANGES_REQUESTED', 'REJECTED', name='approvalstatusenum'), nullable=False),
    sa.Column('decision_notes', sa.Text(), nullable=True),
    sa.Column('decision_timestamp', sa.DateTime(timezone=True), nullable=True),
    sa.Column('checksum', sa.String(length=64), nullable=False),
    sa.Column('signature', sa.String(length=500), nullable=True),
    sa.Column('invalidation_reason', sa.String(length=255), nullable=True),
    sa.Column('invalidated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('invalidation_checksum', sa.String(length=64), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['approver_id'], ['users.id'], name=op.f('fk_approval_records_approver_id_users'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['file_id'], ['files.id'], name=op.f('fk_approval_records_file_id_files'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requestor_id'], ['users.id'], name=op.f('fk_approval_records_requestor_id_users'), ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_approval_records_task_id_tasks'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_approval_records'))
    )
    op.create_index('ix_approval_records_approver', 'approval_records', ['approver_id'], unique=False)
    op.create_index('ix_approval_records_file', 'approval_records', ['file_id'], unique=False)
    op.create_index(op.f('ix_approval_records_file_id'), 'approval_records', ['file_id'], unique=False)
    op.create_index('ix_approval_records_status', 'approval_records', ['status'], unique=False)
    op.create_index('ix_approval_records_task', 'approval_records', ['task_id'], unique=False)
    op.create_index(op.f('ix_approval_records_task_id'), 'approval_records', ['task_id'], unique=False)
    op.create_table('collaboration_notifications',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('recipient_user_id', sa.UUID(), nullable=False),
    sa.Column('trigger_type', sa.String(length=50), nullable=False),
    sa.Column('task_id', sa.UUID(), nullable=True),
    sa.Column('note_id', sa.UUID(), nullable=True),
    sa.Column('comment_id', sa.UUID(), nullable=True),
    sa.Column('triggered_by_user_id', sa.UUID(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('is_read', sa.Boolean(), nullable=False),
    sa.Column('read_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['comment_id'], ['comments.id'], name=op.f('fk_collaboration_notifications_comment_id_comments'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['note_id'], ['notes.id'], name=op.f('fk_collaboration_notifications_note_id_notes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['recipient_user_id'], ['users.id'], name=op.f('fk_collaboration_notifications_recipient_user_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], name=op.f('fk_collaboration_notifications_task_id_tasks'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['triggered_by_user_id'], ['users.id'], name=op.f('fk_collaboration_notifications_triggered_by_user_id_users'), ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_collaboration_notifications'))
    )
    op.create_index('ix_collaboration_notifications_created', 'collaboration_notifications', ['created_at'], unique=False)
    op.create_index('ix_collaboration_notifications_is_read', 'collaboration_notifications', ['is_read'], unique=False)
    op.create_index('ix_collaboration_notifications_recipient', 'collaboration_notifications', ['recipient_user_id'], unique=False)
    op.create_index(op.f('ix_collaboration_notifications_recipient_user_id'), 'collaboration_notifications', ['recipient_user_id'], unique=False)
    op.create_table('mentions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('mentioned_user_id', sa.UUID(), nullable=False),
    sa.Column('mentioned_by_user_id', sa.UUID(), nullable=False),
    sa.Column('comment_id', sa.UUID(), nullable=True),
    sa.Column('note_id', sa.UUID(), nullable=True),
    sa.Column('mention_priority', sa.Integer(), nullable=False),
    sa.Column('context', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['comment_id'], ['comments.id'], name=op.f('fk_mentions_comment_id_comments'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['mentioned_by_user_id'], ['users.id'], name=op.f('fk_mentions_mentioned_by_user_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['mentioned_user_id'], ['users.id'], name=op.f('fk_mentions_mentioned_user_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['note_id'], ['notes.id'], name=op.f('fk_mentions_note_id_notes'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mentions'))
    )
    op.create_index('ix_mentions_comment', 'mentions', ['comment_id'], unique=False)
    op.create_index('ix_mentions_mentioned_by_user', 'mentions', ['mentioned_by_user_id'], unique=False)
    op.create_index('ix_mentions_mentioned_user', 'mentions', ['mentioned_user_id'], unique=False)
    op.create_index(op.f('ix_mentions_mentioned_user_id'), 'mentions', ['mentioned_user_id'], unique=False)
    op.create_table('task_dependency_schedules',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('dependency_id', sa.UUID(), nullable=False),
    sa.Column('lag_days', sa.Integer(), nullable=False, comment='Positive: lag time (wait), negative: lead time (early start)'),
    sa.Column('is_auto_scheduled', sa.Boolean(), nullable=False, comment='Auto-schedule this dependency (Ref: Feature 2.2 AC 3)'),
    sa.Column('is_pinned', sa.Boolean(), nullable=False, comment='Pinned (manually scheduled) - cannot be auto-adjusted'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Timestamp when the record was last updated'),
    sa.ForeignKeyConstraint(['dependency_id'], ['task_dependencies.id'], name=op.f('fk_task_dependency_schedules_dependency_id_task_dependencies')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_task_dependency_schedules')),
    sa.UniqueConstraint('dependency_id', name='uq_task_dependency_schedules_dependency')
    )
    op.create_index('ix_task_dependency_schedules_dependency_id', 'task_dependency_schedules', ['dependency_id'], unique=False)
    op.drop_table('auth_providers')
    op.add_column('api_token_scopes', sa.Column('id', sa.UUID(), nullable=False, comment='Global unique UUID for token-scope mapping'))
    op.alter_column('api_token_scopes', 'token_id',
               existing_type=sa.UUID(),
               comment='API token reference',
               existing_nullable=False)
    op.alter_column('api_token_scopes', 'scope_id',
               existing_type=sa.UUID(),
               comment='API scope reference',
               existing_nullable=False)
    op.create_index('ix_api_token_scopes_scope_id', 'api_token_scopes', ['scope_id'], unique=False)
    op.create_index('ix_api_token_scopes_token_id', 'api_token_scopes', ['token_id'], unique=False)
    op.create_unique_constraint('uq_token_scope', 'api_token_scopes', ['token_id', 'scope_id'])
    op.drop_constraint(op.f('fk_api_token_scopes_scope_id_api_scopes'), 'api_token_scopes', type_='foreignkey')
    op.drop_constraint(op.f('fk_api_token_scopes_token_id_api_tokens'), 'api_token_scopes', type_='foreignkey')
    op.create_foreign_key(op.f('fk_api_token_scopes_scope_id_api_scopes'), 'api_token_scopes', 'api_scopes', ['scope_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('fk_api_token_scopes_token_id_api_tokens'), 'api_token_scopes', 'api_tokens', ['token_id'], ['id'], ondelete='CASCADE')
    op.add_column('comments', sa.Column('mentioned_user_ids', sa.JSON(), nullable=True, comment='List of mentioned user IDs'))
    op.add_column('comments', sa.Column('original_content', sa.Text(), nullable=True, comment='Original content before edits'))
    op.add_column('comments', sa.Column('edit_count', sa.Integer(), nullable=False, comment='Number of edits'))
    op.add_column('comments', sa.Column('reply_count', sa.Integer(), nullable=False, comment='Number of replies'))
    op.add_column('comments', sa.Column('is_pinned', sa.Boolean(), nullable=False, comment='Whether comment is pinned'))
    op.add_column('comments', sa.Column('reactions', sa.JSON(), nullable=True, comment='Emoji reactions with user IDs'))
    op.add_column('file_versions', sa.Column('checksum', sa.String(length=64), nullable=True, comment='SHA256 checksum for this version'))
    op.add_column('files', sa.Column('storage_provider', sa.String(length=50), nullable=False, comment='Storage provider (local, s3, azure)'))
    op.add_column('files', sa.Column('status', sa.Enum('PENDING_SCAN', 'CLEAN', 'QUARANTINED', 'PROCESSING', 'READY', name='attachmentstatusenum'), nullable=False, comment='Virus scan and preview status'))
    op.add_column('files', sa.Column('scan_result', sa.String(length=50), nullable=True, comment='Scan result (clean, quarantined, malicious)'))
    op.add_column('files', sa.Column('preview_url', sa.String(length=500), nullable=True, comment='Preview URL if generated'))
    op.add_column('files', sa.Column('preview_generated', sa.Boolean(), nullable=False, comment='Whether preview was generated'))
    op.add_column('files', sa.Column('approval_status', sa.Enum('PENDING', 'APPROVED', 'CHANGES_REQUESTED', 'REJECTED', name='approvalstatusenum'), nullable=False, comment='Approval status for this file'))
    op.add_column('project_change_requests', sa.Column('type', sa.Enum('SCOPE', 'SCHEDULE', 'COST', 'RESOURCE', name='changerequesttype'), nullable=False, comment='Type of change request'))
    op.alter_column('project_change_requests', 'status',
               existing_type=postgresql.ENUM('PENDING', 'APPROVED', 'REJECTED', 'IMPLEMENTED', name='change_request_status'),
               type_=sa.Enum('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'IMPLEMENTED', 'CANCELLED', name='changerequeststatus'),
               existing_comment='Change request status',
               existing_nullable=False)
    op.add_column('projects', sa.Column('priority', sa.Enum('CRITICAL', 'HIGH', 'MEDIUM', 'LOW', name='projectpriority'), nullable=False, comment='Project priority (CRITICAL / HIGH / MEDIUM / LOW)'))
    op.add_column('sessions', sa.Column('token', sa.String(length=500), nullable=False, comment='JWT token for this session'))
    op.add_column('sessions', sa.Column('user_agent', sa.Text(), nullable=True, comment='Full user agent string for device identification'))
    op.alter_column('sessions', 'device_info',
               existing_type=sa.VARCHAR(length=255),
               comment='Browser/device info (e.g., Chrome on Windows 10)',
               existing_nullable=True)
    op.alter_column('sessions', 'ip_address',
               existing_type=sa.VARCHAR(length=45),
               comment='Client IP address',
               existing_nullable=True)
    op.alter_column('sessions', 'geo_location',
               existing_type=sa.VARCHAR(length=100),
               comment='Estimated geographic location (city, country)',
               existing_nullable=True)
    op.alter_column('sessions', 'last_active_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Last time this session was active',
               existing_nullable=False)
    op.alter_column('sessions', 'revoked_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Timestamp when session was revoked/logged out',
               existing_nullable=True)
    op.create_index(op.f('ix_sessions_user_id'), 'sessions', ['user_id'], unique=False)
    op.create_unique_constraint(op.f('uq_sessions_token'), 'sessions', ['token'])
    op.drop_column('sessions', 'is_current')
    op.add_column('users', sa.Column('full_name', sa.String(length=255), nullable=True, comment="User's full name."))
    op.drop_index(op.f('ix_workspace_invitations_token_hash'), table_name='workspace_invitations')
    op.create_index(op.f('ix_workspace_invitations_token_hash'), 'workspace_invitations', ['token_hash'], unique=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_workspace_invitations_token_hash'), table_name='workspace_invitations')
    op.create_index(op.f('ix_workspace_invitations_token_hash'), 'workspace_invitations', ['token_hash'], unique=False)
    op.drop_column('users', 'full_name')
    op.add_column('sessions', sa.Column('is_current', sa.BOOLEAN(), autoincrement=False, nullable=False))
    op.drop_constraint(op.f('uq_sessions_token'), 'sessions', type_='unique')
    op.drop_index(op.f('ix_sessions_user_id'), table_name='sessions')
    op.alter_column('sessions', 'revoked_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Timestamp when session was revoked/logged out',
               existing_nullable=True)
    op.alter_column('sessions', 'last_active_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Last time this session was active',
               existing_nullable=False)
    op.alter_column('sessions', 'geo_location',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='Estimated geographic location (city, country)',
               existing_nullable=True)
    op.alter_column('sessions', 'ip_address',
               existing_type=sa.VARCHAR(length=45),
               comment=None,
               existing_comment='Client IP address',
               existing_nullable=True)
    op.alter_column('sessions', 'device_info',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='Browser/device info (e.g., Chrome on Windows 10)',
               existing_nullable=True)
    op.drop_column('sessions', 'user_agent')
    op.drop_column('sessions', 'token')
    op.drop_column('projects', 'priority')
    op.alter_column('project_change_requests', 'status',
               existing_type=sa.Enum('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'IMPLEMENTED', 'CANCELLED', name='changerequeststatus'),
               type_=postgresql.ENUM('PENDING', 'APPROVED', 'REJECTED', 'IMPLEMENTED', name='change_request_status'),
               existing_comment='Change request status',
               existing_nullable=False)
    op.drop_column('project_change_requests', 'type')
    op.drop_column('files', 'approval_status')
    op.drop_column('files', 'preview_generated')
    op.drop_column('files', 'preview_url')
    op.drop_column('files', 'scan_result')
    op.drop_column('files', 'status')
    op.drop_column('files', 'storage_provider')
    op.drop_column('file_versions', 'checksum')
    op.drop_column('comments', 'reactions')
    op.drop_column('comments', 'is_pinned')
    op.drop_column('comments', 'reply_count')
    op.drop_column('comments', 'edit_count')
    op.drop_column('comments', 'original_content')
    op.drop_column('comments', 'mentioned_user_ids')
    op.drop_constraint(op.f('fk_api_token_scopes_token_id_api_tokens'), 'api_token_scopes', type_='foreignkey')
    op.drop_constraint(op.f('fk_api_token_scopes_scope_id_api_scopes'), 'api_token_scopes', type_='foreignkey')
    op.create_foreign_key(op.f('fk_api_token_scopes_token_id_api_tokens'), 'api_token_scopes', 'api_tokens', ['token_id'], ['id'])
    op.create_foreign_key(op.f('fk_api_token_scopes_scope_id_api_scopes'), 'api_token_scopes', 'api_scopes', ['scope_id'], ['id'])
    op.drop_constraint('uq_token_scope', 'api_token_scopes', type_='unique')
    op.drop_index('ix_api_token_scopes_token_id', table_name='api_token_scopes')
    op.drop_index('ix_api_token_scopes_scope_id', table_name='api_token_scopes')
    op.alter_column('api_token_scopes', 'scope_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='API scope reference',
               existing_nullable=False)
    op.alter_column('api_token_scopes', 'token_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='API token reference',
               existing_nullable=False)
    op.drop_column('api_token_scopes', 'id')
    op.create_table('auth_providers',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    sa.Column('description', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False, comment='Timestamp when the record was created'),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False, comment='Timestamp when the record was last updated'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_auth_providers')),
    sa.UniqueConstraint('name', name=op.f('uq_auth_providers_name'), postgresql_include=[], postgresql_nulls_not_distinct=False)
    )
    op.drop_index('ix_task_dependency_schedules_dependency_id', table_name='task_dependency_schedules')
    op.drop_table('task_dependency_schedules')
    op.drop_index(op.f('ix_mentions_mentioned_user_id'), table_name='mentions')
    op.drop_index('ix_mentions_mentioned_user', table_name='mentions')
    op.drop_index('ix_mentions_mentioned_by_user', table_name='mentions')
    op.drop_index('ix_mentions_comment', table_name='mentions')
    op.drop_table('mentions')
    op.drop_index(op.f('ix_collaboration_notifications_recipient_user_id'), table_name='collaboration_notifications')
    op.drop_index('ix_collaboration_notifications_recipient', table_name='collaboration_notifications')
    op.drop_index('ix_collaboration_notifications_is_read', table_name='collaboration_notifications')
    op.drop_index('ix_collaboration_notifications_created', table_name='collaboration_notifications')
    op.drop_table('collaboration_notifications')
    op.drop_index(op.f('ix_approval_records_task_id'), table_name='approval_records')
    op.drop_index('ix_approval_records_task', table_name='approval_records')
    op.drop_index('ix_approval_records_status', table_name='approval_records')
    op.drop_index(op.f('ix_approval_records_file_id'), table_name='approval_records')
    op.drop_index('ix_approval_records_file', table_name='approval_records')
    op.drop_index('ix_approval_records_approver', table_name='approval_records')
    op.drop_table('approval_records')
    op.drop_index(op.f('ix_user_presence_user_id'), table_name='user_presence')
    op.drop_index('ix_user_presence_user', table_name='user_presence')
    op.drop_index(op.f('ix_user_presence_task_id'), table_name='user_presence')
    op.drop_index('ix_user_presence_task', table_name='user_presence')
    op.drop_index(op.f('ix_user_presence_note_id'), table_name='user_presence')
    op.drop_index('ix_user_presence_note', table_name='user_presence')
    op.drop_table('user_presence')
    op.drop_index('ix_task_baselines_task_id', table_name='task_baselines')
    op.drop_index('ix_task_baselines_baseline_version', table_name='task_baselines')
    op.drop_table('task_baselines')
    op.drop_index('ix_smart_backlinks_source_note', table_name='smart_backlinks')
    op.drop_index(op.f('ix_smart_backlinks_note_id'), table_name='smart_backlinks')
    op.drop_index('ix_smart_backlinks_note', table_name='smart_backlinks')
    op.drop_table('smart_backlinks')
    op.drop_index('ix_sla_trackers_task_id', table_name='sla_trackers')
    op.drop_index('ix_sla_trackers_status', table_name='sla_trackers')
    op.drop_table('sla_trackers')
    op.drop_index('ix_scheduling_modes_task_id', table_name='scheduling_modes')
    op.drop_table('scheduling_modes')
    op.drop_index('ix_planning_scopes_task_id', table_name='planning_scopes')
    op.drop_table('planning_scopes')
    op.drop_index('ix_planning_audit_logs_task_id', table_name='planning_audit_logs')
    op.drop_index('ix_planning_audit_logs_changed_by', table_name='planning_audit_logs')
    op.drop_index('ix_planning_audit_logs_change_type', table_name='planning_audit_logs')
    op.drop_table('planning_audit_logs')
    op.drop_index('ix_cross_project_dependencies_target', table_name='cross_project_dependencies')
    op.drop_index('ix_cross_project_dependencies_source', table_name='cross_project_dependencies')
    op.drop_table('cross_project_dependencies')
    op.drop_index('ix_public_links_status', table_name='public_links')
    op.drop_index(op.f('ix_public_links_slug'), table_name='public_links')
    op.drop_index(op.f('ix_public_links_note_id'), table_name='public_links')
    op.drop_index('ix_public_links_note', table_name='public_links')
    op.drop_index('ix_public_links_expiration', table_name='public_links')
    op.drop_table('public_links')
    op.drop_index(op.f('ix_note_versions_note_id'), table_name='note_versions')
    op.drop_index('ix_note_versions_created', table_name='note_versions')
    op.drop_table('note_versions')
    op.drop_index('ix_subscription_usages_workspace_id', table_name='subscription_usages')
    op.drop_index(op.f('ix_subscription_usages_subscription_id'), table_name='subscription_usages')
    op.drop_index('ix_subscription_usages_period', table_name='subscription_usages')
    op.drop_table('subscription_usages')
    op.drop_index('ix_sla_policies_project_id', table_name='sla_policies')
    op.drop_table('sla_policies')
    op.drop_index('ix_simulation_sessions_project_id', table_name='simulation_sessions')
    op.drop_index('ix_simulation_sessions_is_active', table_name='simulation_sessions')
    op.drop_table('simulation_sessions')
    op.drop_index('ix_search_indexes_project', table_name='search_indexes')
    op.drop_index(op.f('ix_search_indexes_entity_id'), table_name='search_indexes')
    op.drop_index('ix_search_indexes_entity', table_name='search_indexes')
    op.drop_table('search_indexes')
    op.drop_index('ix_resource_histograms_user_id', table_name='resource_histograms')
    op.drop_index('ix_resource_histograms_project_id', table_name='resource_histograms')
    op.drop_index('ix_resource_histograms_histogram_date', table_name='resource_histograms')
    op.drop_table('resource_histograms')
    op.drop_index('ix_plan_states_project_id', table_name='plan_states')
    op.drop_table('plan_states')
    op.drop_index('ix_personal_exceptions_user_id', table_name='personal_exceptions')
    op.drop_index('ix_personal_exceptions_project_id', table_name='personal_exceptions')
    op.drop_index('ix_personal_exceptions_exception_date', table_name='personal_exceptions')
    op.drop_table('personal_exceptions')
    op.drop_index('ix_notes_user_created', table_name='notes')
    op.drop_index('ix_notes_project_title', table_name='notes')
    op.drop_index(op.f('ix_notes_project_id'), table_name='notes')
    op.drop_index('ix_notes_project_created', table_name='notes')
    op.drop_index(op.f('ix_notes_parent_note_id'), table_name='notes')
    op.drop_index('ix_notes_is_template', table_name='notes')
    op.drop_index('ix_notes_access_level', table_name='notes')
    op.drop_table('notes')
    op.drop_index('ix_invoice_line_items_invoice_id', table_name='invoice_line_items')
    op.drop_table('invoice_line_items')
    op.drop_index(op.f('ix_freelancer_invoices_workspace_id'), table_name='freelancer_invoices')
    op.drop_index('ix_freelancer_invoices_status', table_name='freelancer_invoices')
    op.drop_index(op.f('ix_freelancer_invoices_invoice_number'), table_name='freelancer_invoices')
    op.drop_index('ix_freelancer_invoices_due_date', table_name='freelancer_invoices')
    op.drop_index('ix_freelancer_invoices_created_by_id', table_name='freelancer_invoices')
    op.drop_index('ix_freelancer_invoices_client_id', table_name='freelancer_invoices')
    op.drop_table('freelancer_invoices')
    op.drop_index(op.f('ix_billing_transactions_workspace_id'), table_name='billing_transactions')
    op.drop_index('ix_billing_transactions_status', table_name='billing_transactions')
    op.drop_index(op.f('ix_billing_transactions_invoice_id'), table_name='billing_transactions')
    op.drop_index('ix_billing_transactions_created_at', table_name='billing_transactions')
    op.drop_table('billing_transactions')
    op.drop_index('ix_article_translations_version', table_name='article_translations')
    op.drop_index('ix_article_translations_locale', table_name='article_translations')
    op.drop_table('article_translations')
    op.drop_table('article_tag_map')
    op.drop_index(op.f('ix_workspace_subscriptions_workspace_id'), table_name='workspace_subscriptions')
    op.drop_index('ix_workspace_subscriptions_status', table_name='workspace_subscriptions')
    op.drop_index(op.f('ix_workspace_subscriptions_plan_id'), table_name='workspace_subscriptions')
    op.drop_index('ix_workspace_subscriptions_next_billing_date', table_name='workspace_subscriptions')
    op.drop_table('workspace_subscriptions')
    op.drop_index('ix_working_hours_policies_workspace_id', table_name='working_hours_policies')
    op.drop_table('working_hours_policies')
    op.drop_index(op.f('ix_route_mappings_route_pattern'), table_name='route_mappings')
    op.drop_index('ix_route_mappings_priority', table_name='route_mappings')
    op.drop_index('ix_route_mappings_pattern', table_name='route_mappings')
    op.drop_index('ix_route_mappings_active', table_name='route_mappings')
    op.drop_table('route_mappings')
    op.drop_index(op.f('ix_plugin_installations_workspace_id'), table_name='plugin_installations')
    op.drop_index('ix_plugin_installations_is_active', table_name='plugin_installations')
    op.drop_table('plugin_installations')
    op.drop_index(op.f('ix_oauth_connections_workspace_id'), table_name='oauth_connections')
    op.drop_index(op.f('ix_oauth_connections_user_id'), table_name='oauth_connections')
    op.drop_index(op.f('ix_oauth_connections_is_active'), table_name='oauth_connections')
    op.drop_table('oauth_connections')
    op.drop_index('ix_invoices_workspace_id', table_name='invoices')
    op.drop_index(op.f('ix_invoices_status'), table_name='invoices')
    op.drop_index('ix_invoices_invoice_number', table_name='invoices')
    op.drop_index('ix_invoices_due_date', table_name='invoices')
    op.drop_table('invoices')
    op.drop_index('ix_holiday_calendars_workspace_id', table_name='holiday_calendars')
    op.drop_index('ix_holiday_calendars_holiday_date', table_name='holiday_calendars')
    op.drop_table('holiday_calendars')
    op.drop_index(op.f('ix_consent_grants_workspace_id'), table_name='consent_grants')
    op.drop_index(op.f('ix_consent_grants_user_id'), table_name='consent_grants')
    op.drop_index(op.f('ix_consent_grants_is_granted'), table_name='consent_grants')
    op.drop_index('ix_consent_grants_consent_type', table_name='consent_grants')
    op.drop_table('consent_grants')
    op.drop_index(op.f('ix_clients_workspace_id'), table_name='clients')
    op.drop_index(op.f('ix_clients_owner_id'), table_name='clients')
    op.drop_index('ix_clients_is_active', table_name='clients')
    op.drop_table('clients')
    op.drop_index('ix_article_visibility_scope', table_name='article_visibility')
    op.drop_table('article_visibility')
    op.drop_index('ix_article_versions_current', table_name='article_versions')
    op.drop_index('ix_article_versions_article', table_name='article_versions')
    op.drop_table('article_versions')
    op.drop_index('ix_article_search_indexes_article', table_name='article_search_indexes')
    op.drop_table('article_search_indexes')
    op.drop_index('ix_article_feedback_user', table_name='article_feedback')
    op.drop_index('ix_article_feedback_article', table_name='article_feedback')
    op.drop_table('article_feedback')
    op.drop_index('ix_api_usage_logs_created_at', table_name='api_usage_logs')
    op.drop_index(op.f('ix_api_usage_logs_api_token_id'), table_name='api_usage_logs')
    op.drop_table('api_usage_logs')
    op.drop_index(op.f('ix_password_reset_tokens_user_id'), table_name='password_reset_tokens')
    op.drop_table('password_reset_tokens')
    op.drop_index(op.f('ix_oauth_providers_user_id'), table_name='oauth_providers')
    op.drop_index('idx_oauth_provider_user', table_name='oauth_providers')
    op.drop_table('oauth_providers')
    op.drop_index('ix_failed_searches_searched_at', table_name='failed_searches')
    op.drop_index('ix_failed_searches_query', table_name='failed_searches')
    op.drop_table('failed_searches')
    op.drop_index(op.f('ix_email_verification_tokens_user_id'), table_name='email_verification_tokens')
    op.drop_table('email_verification_tokens')
    op.drop_index(op.f('ix_articles_status'), table_name='articles')
    op.drop_index(op.f('ix_articles_slug'), table_name='articles')
    op.drop_index('ix_articles_category', table_name='articles')
    op.drop_table('articles')
    op.drop_index(op.f('ix_plugins_name'), table_name='plugins')
    op.drop_index('ix_plugins_is_enabled', table_name='plugins')
    op.drop_table('plugins')
    op.drop_index(op.f('ix_plans_name'), table_name='plans')
    op.drop_index('ix_plans_is_active', table_name='plans')
    op.drop_table('plans')
    op.drop_index(op.f('ix_oauth_apps_provider_name'), table_name='oauth_apps')
    op.drop_index(op.f('ix_oauth_apps_is_enabled'), table_name='oauth_apps')
    op.drop_table('oauth_apps')
    op.drop_index(op.f('ix_login_attempts_email'), table_name='login_attempts')
    op.drop_table('login_attempts')
    op.drop_index(op.f('ix_categories_slug'), table_name='categories')
    op.drop_index('ix_categories_parent', table_name='categories')
    op.drop_index(op.f('ix_categories_name'), table_name='categories')
    op.drop_index('ix_categories_active', table_name='categories')
    op.drop_table('categories')
    # ### end Alembic commands ###
